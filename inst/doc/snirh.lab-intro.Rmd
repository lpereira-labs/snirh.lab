---
title: "snirh.lab: From lab tables to SNIRH import files"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
vignette: >
  %\VignetteIndexEntry{snirh.lab: From lab tables to SNIRH import files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```r
#| echo: false
# This vignette shows typical end-to-end usage.
```

## Overview

The **snirh.lab** package helps you convert laboratory analytical data into
the official **SNIRH** (Sistema Nacional de Informação de Recursos Hídricos) batch
import format used in Portugal. It supports validation of station codes,
parameter mapping/units, and consistent output according to SNIRH rules.

Main functions:

- `convert_to_snirh()` — Convert your tidy `data.table`/`data.frame` into the SNIRH import table.
- `get_snirh_stations()` — Download and list known monitoring stations (with optional filtering by status).
- `check_station_status()` — Quickly verify a set of station IDs/codes against the official list.
- `list_snirh_parameters()` — List packaged parameter mappings and units.

> Tip: For reproducibility, we recommend **data.table** for wrangling and **cli** for progress/messages
(used internally by the package).

## Installation

```r
# Install from CRAN (when available)
install.packages("snirh.lab")

# Or install the development version from GitHub
# remotes::install_github("lpereira-labs/snirh.lab")
```

## Minimal example: converting a lab table

Below is a **minimal** example demonstrating the required input columns and a
simple conversion. Replace values with your real data. The example uses
`data.table` to build a small input table.

```r
library(data.table)
library(snirh.lab)

# Minimal input: these columns (in any order) must exist
dt <- data.table(
  snirh_entity = "APA",                 # SNIRH/APA entity (example)
  station_name = "Rio Teste",           # Optional human-readable name
  station_id   = "ST0012345",           # SNIRH station code
  sampling_date= as.Date("2025-08-30"), # YYYY-MM-DD
  parameter    = "Nitrato",             # Your lab parameter name
  unit         = "mg/L",                # Your lab unit
  value        = 2.31                   # Measured value
)

# Convert to SNIRH import format
out <- convert_to_snirh(
  dt,
  matrix = "surface.water",     # or "ground.water", "biota", "sediment"
  verbose = TRUE,               # print progress with cli
  validate_stations = TRUE      # cross-check station codes when available
)

# Inspect result
out[]
```

### Handling censored values (e.g., "<", LOQ)

If your lab reports censored values such as `"<0.5"`, pre-process them into
numeric values and flag columns (e.g., `value = 0.5` and an indicator column).
If your workflow already encodes censoring, add/merge that information **before**
calling `convert_to_snirh()`. The package focuses on **format conversion** and
**basic validation**; specialized imputation or survival-model handling should
be done upstream in your pipeline.

## Getting station information

`get_snirh_stations()` retrieves station metadata from the SNIRH geoportal.
Depending on your setup, it can return an `sf` object if `sf` is installed.

```r
# NOTE: This requires internet access and can take some seconds.
# eval = FALSE here to keep the vignette light.
# (Uncomment to run in your session.)

# library(snirh.lab)
# st <- get_snirh_stations(active_only = TRUE)
# head(st)
```

You can also check specific codes quickly:

```r
# eval = FALSE
# check_station_status(c("ST0012345", "ST0098765"))
```

## Listing packaged parameters

The package ships an internal `parameters` dataset used for mapping laboratory
names/units to SNIRH codes and units.

```r
# Example usage
list_snirh_parameters()[1:10]
```

## End-to-end sketch

1. Read and tidy your lab export (CSV/Excel) with `data.table`.
2. Harmonize column names to match package expectations.
3. Optional: join extra metadata (e.g., LOQ flags, sample IDs).
4. Run `convert_to_snirh()` for the correct matrix (surface/ground/biota/sediment).
5. Export the resulting table to CSV for SNIRH import.

```r
# Example export
# fwrite(out, file = "snirh_import_surface_2025-08.csv", sep = ";")
```

## Reproducible tips

- Store your parameter/LOQ dictionaries under version control.
- Add a brief `README` alongside your export scripts.
- Consider attaching a `sessionInfo()` dump when you deliver the import file.
